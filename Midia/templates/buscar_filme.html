<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static '/css/buscar_filme.css' %}">
    <title>Busca de Mídia</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <h1>Busca de Mídia</h1>
      <form method="post" id="form-midia">
        {% csrf_token %}
        <div class="form-group">
          <label for="tipo">Tipo de Mídia:</label>
          <select id="tipo" name="tipo" required>
            <option value="filme" {% if request.POST.tipo == "filme" %}selected{% endif %}>Filme</option>
            <option value="serie" {% if request.POST.tipo == "serie" %}selected{% endif %}>Série</option>
          </select>
        </div>

        <div class="form-group">
          <label for="content">Conteúdo:</label>
          <input
            type="text"
            id="content"
            name="content"
            value="{{ request.POST.content }}"
            required
          />
        </div>

        <input type="hidden" name="api_externa" id="api-externa" value="false" />

        <div class="form-actions">
            <button type="submit">Buscar</button>
            {% if midias %}
            <button
            type="submit"
            onclick="setApiExternaTrue('form-midia', 'api-externa')"
            id="nao-achou-btn"
            style="display: none;"
            >
            <i class="fas fa-search"></i> Não achou o que procurava?
            </button>
            <script>
            document.getElementById("nao-achou-btn").style.display = "block";
            </script>
            {% endif %}
            </div>

          </form>
          
          {% if midias.0.titulo %}
          <div class="midia-table" id="midia-table">
            <h5>Resultados Encontrados:</h5>
            <table>
            <thead>
              <tr>
              <th>Nome</th>
              <th>Data de Lançamento</th>
              <th>Nota</th>
              <th>Gênero</th>
              <th>Selecionar</th>
              </tr>
            </thead>
            <tbody>
              {% for midia in midias %}
              <tr>
                <td>{{ midia.titulo }}</td>
                <td>{{ midia.data_lancamento }}</td>
                <td>{{ midia.nota }}</td>
                <td>{{ midia.genero }}</td>
                <td>
                <button
                  type="button"
                  class="select-btn"
                  onclick="selectMedia('{{ midia.titulo|escapejs }}', '{{ midia.data_lancamento|escapejs }}', '{{ midia.nota|escapejs }}', '{{ midia.genero|escapejs }}', '{{ midia.id|escapejs }}')"
                >
                  Selecionar
                </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            </table>
          </div>
          {% else %}
          <p class="no-results">Nenhuma midia encontrada ainda.</p>
          {% endif %}
    </div>

    <script>
      document.getElementById("form-midia").onsubmit = function (event) {
        event.preventDefault();

        const tipo = document.getElementById("tipo").value;
        const actionUrl = tipo === "filme"
          ? "{% url 'Midia:buscar_filme' %}"
          : "{% url 'Midia:buscar_serie' %}";

        this.action = actionUrl;
        this.submit();
      };

      function setApiExternaTrue(formId, hiddenInputId) {
        document.getElementById(hiddenInputId).value = "true";
        document.getElementById(formId).submit();
      }

      function selectMedia(titulo, dataLancamento , nota, genero, id) {
        const midiaSelecionada = {
          titulo: titulo,
          data_lancamento: dataLancamento,
          nota: nota,
          genero: genero,
          id: id
        };
        salvarMidia(midiaSelecionada);
      }

      function salvarMidia(midia) {
        fetch("salvar_midia", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify(midia),
        })
        .then((response) => {
          if (response.status === 200) {
            return response.json();
          } else {
            throw new Error('Erro ao salvar a mídia.');
          }
        })
        .then((data) => {
          alert("Mídia salva com sucesso!");
        })
        .catch((error) => {
          alert(error.message);
        });
      }
    </script>
  </body>
</html>
